<html>
  <head>
    <style>
      // TODO: rm clock
      .psh__clock {
        height: 40px;
        width: 50px;
        border: 1px solid #ababab;
      }

      * {
        box-sizing: border-box;
      }
      @keyframes psh__falling {
        0% {
          transform: translateY(-100px);
        }
        100% {
          transform: translateY(700px);
        }
      }
      .psh__falling {
        animation-name: psh__falling;
        animation-duration: 2s;
        animation-timing-function: linear;
        animation-delay: 0ms;
        animation-iteration-count: 1;
        animation-fill-mode: forwards;
      }
      .psh__frame {
        position: fixed;
        bottom: 0;
        right: 300px;
        z-index: 510;
      }
      .psh__guitar {

      }
      .psh__head {
        position: relative;
        width: 368px;
        z-index: 530;
      }
      .psh__head-hand {
        margin: 0 auto;
        height: 368px;
        width: 251px;
        background: url(hand.png) no-repeat center;
      }
      .psh__peg {
        position: absolute;
        height: 42px;
        width: 43px;
        background: url(peg.png) no-repeat center;
      }
      .psh__peg--nw {
        top: 125px;
        left: 0;
      }
      .psh__peg--sw {
        top: 205px;
        left: 0;
      }
      .psh__peg--ne {
        top: 125px;
        right: 0;
        transform: scaleX(-1);
      }
      .psh__peg--se {
        top: 205px;
        right: 0;
        transform: scaleX(-1);
      }
      .psh__neck {
        position: relative;
        overflow: hidden;
        width: 200px;
        height: 475px;
        margin: -100px auto 0 auto;
        background-color: #222222;
        z-index: 520;
      }
      .psh__frets {
        position: absolute;
        width: 100%;
        padding-top: 15px;
      }
      .psh__fret {
        width: 100%;
        margin-bottom: 87px;
        background-color: #EBEBEB;
        border-top: 2px solid #827E7D;
        border-bottom: 2px solid #827E7D;
      }
      .psh__strings {
        position: absolute;
        width: 100%;
        padding: 0 25px;
        font-size: 0;
      }
      .psh__string {
        display: inline-block;
        width: 5px;
        height: 475px;
        margin-right: 43px;
        background-color: #8E8C8C;
        border-left: 2px solid #9F9F9E;
        border-right: 2px solid #9F9F9E;
      }
      .psh__string:last-child {
        margin-right: 0;
      }
      .psh__lanes {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 475px;
        font-size: 0;
      }
      .psh__lane {
        display: inline-block;
        height: 475px;
        width: 50px;
        padding: 0 8px 0 9px;
        vertical-align: top;
        overflow: hidden;
      }
      ,psh__token {
        height: 33px;
        width: 33px;
        border-radius: 50%;
        z-index: 540;
      }
      .psh__lane--1 .psh__token {
        background-color: #23B45D;
      }
      .psh__lane--2 .psh__token {
        background-color: #DC1F26;
      }
      .psh__lane--3 .psh__token {
        background-color: #F96816;
      }
      .psh__lane--4 .psh__token {
        background-color: #0C9DBF;
      }
      .psh__hitzone {
        position: absolute;
        bottom: 32px;
        left: 71px;
        height: 70px;
        width: 300px;
        background-color: rgba(255, 255, 255, .7);
        border-radius: 5px;
        border: 2px solid #F05A28;
        z-index: 530;
      }
      .psh__hitzone--hit {
        background: rgba(190, 254, 197, 0.7)
        border-color: #23B45D;
      }
      .psh__hitzone--miss {
        background-color: rgba(241, 196, 196, 0.7)
        border-color: #DC1F26;
      }
      .psh__hitkeys {
        margin: 17px 0 0 22px;
      }
      .psh__hitkey {
        height: 33px;
        width: 33px;
        margin-right: 11px;
        border-width: 3px;
        border-style: solid;
        text-align: center;
        line-height: 28px;
        border-radius: 50%;
        font-family: sans-serif;
        font-size: 12px;
        font-weight: bolder;
        display: inline-block;
        background-color: #D8D8D8;
      }
      .psh__hitkey--a {
        border-color: #23B45D;
        color: #23B45D;
      }
      .psh__hitkey--s {
        border-color: #DC1F26;
        color: #DC1F26;
      }
      .psh__hitkey--d {
        border-color: #F96816;
        color: #F96816;
      }
      .psh__hitkey--f {
        border-color: #0C9DBF;
        color: #0C9DBF;
      }
    </style>
  </head>
  <body>

    <div class="psh__frame">
      <div class="psh__clock"></div>
      <div class="psh__sound"></div>
      <div class="psh__guitar">
        <div class="psh__head">
          <div class="psh__head-hand"></div>
          <div class="psh__peg psh__peg--nw"></div>
          <div class="psh__peg psh__peg--sw"></div>
          <div class="psh__peg psh__peg--ne"></div>
          <div class="psh__peg psh__peg--se"></div>
        </div>
        <div class="psh__neck">
          <div class="psh__frets">
            <div class="psh__fret"></div>
            <div class="psh__fret"></div>
            <div class="psh__fret"></div>
            <div class="psh__fret"></div>
            <div class="psh__fret"></div>
            <div class="psh__fret"></div>
          </div>
          <div class="psh__strings">
            <div class="psh__string"></div>
            <div class="psh__string"></div>
            <div class="psh__string"></div>
            <div class="psh__string"></div>
          </div>
          <div class="psh__lanes">
            <div class="psh__lane psh__lane--1"></div>
            <div class="psh__lane psh__lane--2"></div>
            <div class="psh__lane psh__lane--3"></div>
            <div class="psh__lane psh__lane--4"></div>
          </div>
        </div>
        <div class="psh__hitzone">
          <div class="psh__hitkeys">
            <div class="psh__hitkey psh__hitkey--a">A</div>
            <div class="psh__hitkey psh__hitkey--s">S</div>
            <div class="psh__hitkey psh__hitkey--d">D</div>
            <div class="psh__hitkey psh__hitkey--f">F</div>
          </div>
        </div>
      </div>
    </div>
  </body>

  <script>

    window.psHero = {
      start: function start() {
        function hasClass(el, className) {
          if (el.classList)
            return el.classList.contains(className)
          else
            return !!el.className.match(new RegExp('(\\s|^)' + className + '(\\s|$)'))
        }

        function addClass(el, className) {
          if (el.classList)
            el.classList.add(className)
          else if (!hasClass(el, className)) el.className += " " + className
        }

        function removeClass(el, className) {
          if (el.classList)
            el.classList.remove(className)
          else if (hasClass(el, className)) {
            var reg = new RegExp('(\\s|^)' + className + '(\\s|$)')
            el.className=el.className.replace(reg, ' ')
          }
        }

        function loadSound(sound, filePath, done) {
          sound.innerHTML = '<audio class="psh__audio">' +
              '<source src="' + filePath + '.mp3" type="audio/mpeg" />' +
              '<source src="' + filePath + '.ogg" type="audio/ogg" />' +
            '</audio>'
        }

        function createTimer() {
          var startTime = Date.now()
          return function timer() {
            return Date.now() - startTime
          }
        }

        function roundTimeTo(time, nearest) {
          return Math.round(time / nearest) * nearest
        }

        function roundTime(time) {
          return roundTimeTo(time, 500)
        }

        function showTiming(clock, getTime) {
          clock.innerHTML = roundTime(getTime())
        }

        function isActionKey(KEYS, key) {
          return Object.keys(KEYS)
            .map(function (k) { return +k })
            .indexOf(key) > -1
        }

        function getLane(KEYS, key) {
          return KEYS[key]
        }

        function isInLane(targetLane, lane) {
          // console.log("targetLane, lane", targetLane, lane, targetLane === lane)
          return targetLane === lane
        }

        function isInTime(targetTime, time) {
          var allowance = 500
          var retval = time <= targetTime + allowance
                  && time >= targetTime - allowance
          // console.log('low <= time <= hi', (targetTime - allowance), time, (targetTime + allowance), retval)
          return retval
        }

        function isHit(song, lane, time) {
          return song.filter(function (note) {
            return isInTime(time, note.time) && isInLane(lane, note.lane)
          }).length > 0
        }

        function detectHit(getTime, evt) {
          var key = evt.which
          if (isActionKey(KEYS, key)) {
            var hit = isHit(song, getLane(KEYS, key), getTime())
            console.log("hit", hit)
            // TODO: keep score

            if (hit) {
              score++
              addClass(hitzone, 'psh__hitzone--hit')
              setTimeout(function () { removeClass(hitzone, 'hit') }, 400)
            } else {
              addClass(hitzone, 'psh__hitzone--miss')
              setTimeout(function () { removeClass(hitzone, 'miss') }, 400)
            }
          }
        }

        function isTimeToDrop(targetTime, time) {
          return (TIME_TO_HITZONE + roundTimeTo(targetTime, 100)) === time
        }

        function dropNote(note) {
          var el = document.createElement('div')
          el.className = 'psh__token psh__falling'

          var lane = document.querySelector('.psh__lane--' + note.lane)
          lane.appendChild(el)
          setTimeout(function () {
            lane.removeChild(el)
          }, TIME_TO_DISAPPEAR)
        }

        function dropNotes(getTime, evt) {
          song.forEach(function (note) {
            if (isTimeToDrop(getTime(), note.time)) {
              console.log('drop time!', note.lane, note.time)
              dropNote(note)
            }
          })
        }

        function endGame() {
          console.log("score", score, song.length)


        }

        var TIME_TO_HITZONE = 1000
        var TIME_TO_DISAPPEAR = 2000
        var SONG_TIME = 25000
        var SOUND_FILE_PATH = 'song'
        var KEYS = {
          65: 1, // A
          83: 2, // S
          68: 3, // D
          70: 4  // F
        }

        var song = [
          { lane: 1, time: 1800 },
          { lane: 2, time: 2700 },
          { lane: 3, time: 3600 },
          { lane: 4, time: 4500 },
          { lane: 1, time: 5500 },
          { lane: 2, time: 6400 },
          { lane: 3, time: 7300 },
          { lane: 4, time: 8200 },
          { lane: 1, time: 9100 },
          { lane: 3, time: 10000 },
          { lane: 2, time: 11000 },
          { lane: 4, time: 11900 },
          { lane: 1, time: 12800 },
          { lane: 3, time: 13700 },
          { lane: 2, time: 14700 },
          { lane: 4, time: 15500 },
          { lane: 1, time: 16500 },
          { lane: 2, time: 17400 },
          { lane: 3, time: 18300 },
          { lane: 4, time: 19200 },
          { lane: 1, time: 20100 },
          { lane: 2, time: 21000 },
          { lane: 3, time: 21900 },
          { lane: 4, time: 22900 }
        ]
        var score = 0
        var clock = document.querySelector('.psh__clock')
        var sound = document.querySelector('.psh__sound')
        var hitzone = document.querySelector('.psh__hitzone')

        loadSound(sound, SOUND_FILE_PATH)

        var audio = document.querySelector('.psh__audio')
        audio.addEventListener('canplaythrough', function () {
          var getTime = createTimer()
          document.addEventListener('keydown', detectHit.bind(this, getTime))
          audio.play()
          setInterval(dropNotes.bind(this, getTime), 100)
          setInterval(showTiming.bind(this, clock, getTime), 500)

          setTimeout(endGame, SONG_TIME)
        })
      }
    }

    psHero.start()

  </script>
</html>
